<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>読書ダッシュボード</title>
  <link rel="stylesheet" href="./home.css" />
  <link rel="stylesheet" href="./ranking.css" />
  <link rel="stylesheet" href="./search.css" />
  <!-- jQuery / Chart.js -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="./insertHTML.js"></script>
  <script src="./pageswap.js"></script>
</head>

<body>
    <div class="app">
        <!-- ======= Header ======= -->
        <header>
            <div id="header"></div>
        </header>

        <!-- ======= Crumbs (任意) ======= -->
        <!-- <div class="topbar" style="padding-top:8px;padding-bottom:0;">
            <div class="crumbs"><span>📚 <b>読書管理</b></span><span>› ダッシュボード</span></div>
        </div> -->

        <!-- ======= Main ======= -->
        <main>

            <!-- ===== Sidebar ===== -->
            <aside class="sidebar">

                <!-- 今月の読書数? -->
                <section class="panel">
                    <div class="hd">今月の読書数</div>
                    <div class="bd">
                    <div style="font-size:32px; font-weight:800; margin-bottom:4px;">
                        <span id="monthlyCount">0</span>
                        <small style="font-size:14px; color:var(--muted); margin-left:2px;">冊</small>
                    </div>

                    <p class="muted" style="margin:8px 0 10px;">現在の進捗</p>
                    <div id="inProgressArea" style="display:grid;gap:10px;">
                    <!-- JS で進捗 99% 以下の本を描画します -->
                    </div>

                    </div>
                </section>

                <!-- 登録・検索 -->
                <section class="panel">
                    <div class="hd">本のタイトル検索
                    </div>
                    <div class="bd search-bd">
                        <input type="text" id="bookTitleInput" placeholder="タイトルを入力" />
                        <nav><button onclick="showPage('kensaku')" id="searchBookBtn">検索</button></nav>
                    </div>
                </section>

                <!-- ジャンルから選ぶ -->
                <section class="panel">
                    <div class="hd">ジャンルから選ぶ</div>
                    <div class="bd">
                    <div class="chips" aria-label="ジャンル">
                        <span class="chip">ビジネス</span>
                        <span class="chip">小説</span>
                        <span class="chip">技術・IT</span>
                        <span class="chip">芸術・文化</span>
                        <span class="chip">数学</span>
                    </div>
                    </div>
                </section>

                <!-- 人気ワード -->
                <section class="panel">
                    <div class="hd">人気のワードから選ぶ</div>
                    <div class="bd">
                    <div class="chips">
                        <span class="chip">統計</span>
                        <span class="chip">AWS</span>
                        <span class="chip">Azure</span>
                        <span class="chip">デザイン</span>
                    </div>
                    </div>
                </section>

                <!-- 著者 -->
                <section class="panel">
                    <div class="hd">著者名から選ぶ</div>
                    <div class="bd">
                    <div class="chips">
                        <span class="chip">AWS</span>
                        <span class="chip">Azure</span>
                        <span class="chip">TK</span>
                    </div>
                    </div>
                </section>

            </aside>

            <!-- ===== Content ===== -->
            <section class="content">

                <!-- ページ遷移 -->
                <!-- ログイン -->
                <!-- <div id="login" class="page active"></div> -->

                <!-- ページ遷移 -->
                <div id="home" class="page active">
                    <!-- ランキング -->
                    <section class="panel">
                        <iframe id="rankingFrame" src="ranking.html" width="100%" style="border:none; display:block; padding:0; margin:0;"></iframe>

                        <script> 
                        function resizeIframe() { 
                            const iframe = document.getElementById('rankingFrame'); 
                            if (iframe.contentWindow.document.body) { 
                                const height = iframe.contentWindow.document.body.scrollHeight; 
                                iframe.style.height = height + 30 + 'px'; 
                            } 
                        } 
                        document.getElementById('rankingFrame').addEventListener('load', resizeIframe); </script>
                    </section>
                </div>

                <!-- ページ遷移 -->
                <div id="kensaku" class="page">
                    <div id="bookSearchResults"></div>
                </div>

                <!-- ページ遷移 -->
                <div id="recomend" class="page">
                    <!-- あなたへのおすすめ -->
                    <section class="panel">
                        <div class="bd">
                        <div class="section-hd">
                            <strong>あなたへのおすすめ</strong>
                            <span class="muted">更新: 今日</span>
                        </div>
                        <div class="rail" aria-label="あなたへのおすすめ一覧">
                            <div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div>
                        </div>
                        </div>
                    </section>
                </div>

                <!-- ページ遷移 -->
                <div id="popular" class="page">
                    <!-- みんなが読んでいる本 -->
                    <section class="panel">
                        <div class="bd">
                        <div class="section-hd">
                            <strong>みんなが読んでいる本</strong>
                            <span class="muted">リアルタイム</span>
                        </div>
                        <div class="rail" aria-label="トレンド本一覧">
                            <div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div>
                        </div>
                        </div>
                    </section>
                </div>

                <!-- ページ遷移 -->
                <div id="mypage" class="page"></div>
            </section>
            
        </main>
    </div>
    <script src="./search.js"></script>
    <script src="./progressupdate.js"></script>
    <!-- ★ ランキング iframe からの冊数を受け取り表示する（追記） -->
    <script>
        // 1) iframe からの通知を受信して「今月の読書数」を更新
        window.addEventListener('message', (e) => {
            const data = e?.data;
            if (!data || typeof data !== 'object') return;

            // 進捗100%のみで集計された今月の冊数
            if (data.type === 'monthly-count') {
            const el = document.getElementById('monthlyCount');
            if (el) el.textContent = Number(data.count || 0);
            }

            // （任意）月変更イベントを受けたい場合はここで処理
            // if (data.type === 'month-change') { ... }
        });

        // 2) iframe 読み込み完了時に、初回の冊数送信を依頼（保険）
        const rankingFrame = document.getElementById('rankingFrame');
        rankingFrame.addEventListener('load', () => {
        // ランキング側（ranking.js）でこのリクエストを受けて monthly-count を postMessage してください
        rankingFrame.contentWindow?.postMessage({ type: 'request-monthly-count' }, '*');
    });
    </script>

    <script>
        // ==== 設定 ====
        const API_HOME = "http://localhost:4000";
        const MY_USER_ID_HOME = 6;

        // 月→開始/終了 文字列
        function monthToRangeHome(ym) {
            let d = ym ? new Date(ym + "-01") : new Date();
            const y = d.getFullYear(), m = d.getMonth();
            const pad = n => String(n).padStart(2, "0");
            const s = new Date(y, m, 1), e = new Date(y, m + 1, 0);
            return {
                start: `${s.getFullYear()}-${pad(s.getMonth()+1)}-${pad(s.getDate())}`,
                end:   `${e.getFullYear()}-${pad(e.getMonth()+1)}-${pad(e.getDate())}`
            };
        }
        function betweenHome(dateStr, s, e){
            if(!s && !e) return true;
            const dt = new Date(dateStr);
            return (!s || dt >= new Date(s)) && (!e || dt <= new Date(e + "T23:59:59.999"));
        }

        // ランキング iframe から月が送られて来たら追従
        let currentYMFromRanking = null;
        window.addEventListener("message", (e)=>{
            const data = e?.data;
            if(!data || typeof data !== "object") return;

            if (data.type === "monthly-count" || data.type === "month-change") {
                currentYMFromRanking = data.ym || null;
                renderInProgressArea(currentYMFromRanking);
            }
        });

        // 初回：ページ読込時にも当月で描画（iframe から来ない環境でも出るように）
        document.addEventListener("DOMContentLoaded", () => {
        renderInProgressArea(null);
        });

        // ===== 進捗（99%以下）リスト描画 =====
        async function renderInProgressArea(ym){
        const area = document.getElementById("inProgressArea");
        if(!area) return;

        const { start, end } = monthToRangeHome(ym);

        try{
            // books は画像・タイトルのために取得（無くても動くように try/catch）
            const readings = await fetch(`${API_HOME}/readings`).then(r=>r.json());
            let books = [];
            try { books = await fetch(`${API_HOME}/books`).then(r=>r.json()); } catch(_) {}

                const list = readings
                .filter(r =>
                r.userId === MY_USER_ID_HOME &&
                betweenHome(r.date, start, end) &&
                (r.progress ?? 0) <= 99
                )
                .map(r => ({
                ...r,
                book: books.find(b => b.id === r.bookId) || {}
                }));

                if(list.length === 0){
                    area.innerHTML = `<div class="muted">（進行中の本はありません）</div>`;
                    return;
                }

                // 読みやすくタイトル順
                list.sort((a,b)=> (a.book?.title||"").localeCompare(b.book?.title||"","ja"));

                area.innerHTML = list.map(item=>{
                    const img   = item.book?.image || "images/noimage.png";
                    const title = item.book?.title || "（タイトル不明）";
                    const prog  = item.progress ?? 0;
                    return `
                    <div class="card-row" style="display:flex;align-items:center;gap:12px;">
                    <img src="${img}" alt="" style="width:36px;height:48px;object-fit:cover;border-radius:8px;background:#eee;">
                    <div style="flex:1;min-width:0;">
                    <div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${title}</div>
                    <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
                    <div style="flex:1;height:6px;border-radius:999px;background:#ececec;overflow:hidden;">
                    <div style="height:100%;width:${prog}%;background:#8aa9ff;"></div>
                    </div>
                    <span style="width:42px;text-align:right;" class="muted">${prog}%</span>
                    </div>
                    </div>
                    </div>
                    `;
                }).join("");
        }catch(err){
        console.error(err);
        area.innerHTML = `<div style="color:#c00;">進捗データの取得に失敗しました</div>`;
        }
        }
    </script>

</body>

</html>
