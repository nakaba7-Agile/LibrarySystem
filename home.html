<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>読書ダッシュボード</title>
  <link rel="stylesheet" href="./home.css" />
  <link rel="stylesheet" href="./ranking.css" />
  <!-- jQuery / Chart.js -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="./insertHTML.js"></script>
  <script src="./pageswap.js"></script>
</head>

<body>
    <div class="app">
        <!-- ======= Header ======= -->
        <header>
            <div id="header"></div>
        </header>

        <!-- ======= Crumbs (任意) ======= -->
        <!-- <div class="topbar" style="padding-top:8px;padding-bottom:0;">
            <div class="crumbs"><span>📚 <b>読書管理</b></span><span>› ダッシュボード</span></div>
        </div> -->

        <!-- ======= Main ======= -->
        <main>

            <!-- ===== Sidebar ===== -->
            <aside class="sidebar">

                <!-- 今月の読書数? -->
                <section class="panel">
                    <div class="hd">今月の読書数</div>
                    <div class="bd">
                    <div style="font-size:32px; font-weight:800; margin-bottom:4px;">
                        <span id="monthlyCount">0</span>
                        <small style="font-size:14px; color:var(--muted); margin-left:2px;">冊</small>
                    </div>

                    <p class="muted" style="margin:8px 0 10px;">現在の進捗</p>
                    <div class="progress-wrap">
                        <div class="progress-box">📘</div>
                        <div>
                        <div class="progress-label">
                            <span class="muted">基本情報技術者試験</span>
                        </div>
                        <input type="range" id="progressSlider" value="0" min="0" max="100" />
                        <span id="progressPercent">0%</span>
                        <div class="row">
                            <button class="btn">更新</button>
                        </div>
                        </div>
                    </div>
                    </div>
                </section>

                <!-- 登録・検索 -->
                <section class="panel">
                    <div class="hd">本のタイトル検索</div>
                    <div class="bd search-bd">
                        <input type="text" id="bookTitleInput" placeholder="タイトルを入力" />
                        <nav><button onclick="showPage('kensaku')" id="searchBookBtn">検索</button></nav>
                    </div>
                </section>

                <!-- ジャンルから選ぶ -->
                <section class="panel">
                    <div class="hd">ジャンルから選ぶ</div>
                    <div class="bd">
                    <div class="chips" aria-label="ジャンル">
                        <span class="chip">ビジネス</span>
                        <span class="chip">小説</span>
                        <span class="chip">技術・IT</span>
                        <span class="chip">芸術・文化</span>
                        <span class="chip">数学</span>
                    </div>
                    </div>
                </section>

                <!-- 人気ワード -->
                <section class="panel">
                    <div class="hd">人気のワードから選ぶ</div>
                    <div class="bd">
                    <div class="chips">
                        <span class="chip">統計</span>
                        <span class="chip">AWS</span>
                        <span class="chip">Azure</span>
                        <span class="chip">デザイン</span>
                    </div>
                    </div>
                </section>

                <!-- 著者 -->
                <section class="panel">
                    <div class="hd">著者名から選ぶ</div>
                    <div class="bd">
                    <div class="chips">
                        <span class="chip">AWS</span>
                        <span class="chip">Azure</span>
                        <span class="chip">TK</span>
                    </div>
                    </div>
                </section>

            </aside>

            <!-- ===== Content ===== -->
            <section class="content">

                <!-- ページ遷移 -->
                <div id="home" class="page active">
                    <!-- ランキング -->
                    <section class="panel">
                        <!-- タイトルの右にフィルタ -->
                        <div class="header-bar">
                            <div class="title-line">
                            <span class="title">月間読書数ランキング</span>
                            <div class="filters">
                                <input type="month" id="month" class="pill" />
                                <select id="selDept" class="pill"><option value="">すべての部門</option></select>
                                <select id="selPos"  class="pill"><option value="">すべての役職</option></select>
                            </div>
                            </div>
                        </div>

                        <div class="chart-wrap">
                            <div id="chartInner" class="chart-inner">
                            <canvas id="mainCanvas"></canvas>
                            </div>
                            <!-- 空表示（中央に） -->
                            <div id="empty" class="empty">該当データがありません</div>
                        </div>

                        <script src="./ranking.js"></script>

                        <script>
                        const canvas = document.getElementById("mainCanvas");
                        canvas.width = data.labels.length * 100;  // ラベル数×幅で調整
                        </script>
                    </section>
                </div>

                <!-- ページ遷移 -->
                <div id="kensaku" class="page">
                    <div id="bookSearchResults"></div>
                </div>

                <!-- ページ遷移 -->
                <div id="recomend" class="page">
                    <!-- あなたへのおすすめ -->
                    <section class="panel">
                        <div class="bd">
                        <div class="section-hd">
                            <strong>あなたへのおすすめ</strong>
                            <span class="muted">更新: 今日</span>
                        </div>
                        <div class="rail" aria-label="あなたへのおすすめ一覧">
                            <div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div>
                        </div>
                        </div>
                    </section>
                </div>

                <!-- ページ遷移 -->
                <div id="popular" class="page">
                    <!-- みんなが読んでいる本 -->
                    <section class="panel">
                        <div class="bd">
                        <div class="section-hd">
                            <strong>みんなが読んでいる本</strong>
                            <span class="muted">リアルタイム</span>
                        </div>
                        <div class="rail" aria-label="トレンド本一覧">
                            <div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div>
                        </div>
                        </div>
                    </section>
                </div>

                <!-- ページ遷移 -->
                <div id="mypage" class="page"></div>
            </section>
            
        </main>
    </div>
    <script src="./progressupdate.js"></script>
    <script src="./search.js"></script>
    <!-- ★ ランキング iframe からの冊数を受け取り表示する（追記） -->
    <script>
        // 1) iframe からの通知を受信して「今月の読書数」を更新
        window.addEventListener('message', (e) => {
            const data = e?.data;
            if (!data || typeof data !== 'object') return;

            // 進捗100%のみで集計された今月の冊数
            if (data.type === 'monthly-count') {
            const el = document.getElementById('monthlyCount');
            if (el) el.textContent = Number(data.count || 0);
            }

            // （任意）月変更イベントを受けたい場合はここで処理
            // if (data.type === 'month-change') { ... }
        });

        // 2) iframe 読み込み完了時に、初回の冊数送信を依頼（保険）
        const rankingFrame = document.getElementById('rankingFrame');
        rankingFrame.addEventListener('load', () => {
        // ランキング側（ranking.js）でこのリクエストを受けて monthly-count を postMessage してください
        rankingFrame.contentWindow?.postMessage({ type: 'request-monthly-count' }, '*');
    });
    </script>

</body>

</html>
