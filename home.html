<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>èª­æ›¸ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link rel="stylesheet" href="./home.css" />
  <link rel="stylesheet" href="./ranking.css" />
  <link rel="stylesheet" href="./search.css" />
  <!-- jQuery / Chart.js -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="./insertHTML.js"></script>
  <script src="./pageswap.js"></script>
</head>

<body>
    <div class="app">
        <!-- ======= Header ======= -->
        <header>
            <div id="header"></div>
        </header>

        <!-- ======= Crumbs (ä»»æ„) ======= -->
        <!-- <div class="topbar" style="padding-top:8px;padding-bottom:0;">
            <div class="crumbs"><span>ğŸ“š <b>èª­æ›¸ç®¡ç†</b></span><span>â€º ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span></div>
        </div> -->

        <!-- ======= Main ======= -->
        <main>

            <!-- ===== Sidebar ===== -->
            <aside class="sidebar">

                <!-- ä»Šæœˆã®èª­æ›¸æ•°? -->
                <section class="panel">
                    <div class="hd">ä»Šæœˆã®èª­æ›¸æ•°</div>
                    <div class="bd">
                    <div style="font-size:32px; font-weight:800; margin-bottom:4px;">
                        <span id="monthlyCount">0</span>
                        <small style="font-size:14px; color:var(--muted); margin-left:2px;">å†Š</small>
                    </div>

                    <p class="muted" style="margin:8px 0 10px;">ç¾åœ¨ã®é€²æ—</p>
                    <div id="inProgressArea" style="display:grid;gap:10px;">
                    <!-- JS ã§é€²æ— 99% ä»¥ä¸‹ã®æœ¬ã‚’æç”»ã—ã¾ã™ -->
                    </div>

                    </div>
                </section>

                <!-- ç™»éŒ²ãƒ»æ¤œç´¢ -->
                <section class="panel">
                    <div class="hd">æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢
                    </div>
                    <div class="bd search-bd">
                        <input type="text" id="bookTitleInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" />
                        <nav><button onclick="showPage('kensaku')" id="searchBookBtn">æ¤œç´¢</button></nav>
                    </div>
                </section>

                <!-- ã‚¸ãƒ£ãƒ³ãƒ«ã‹ã‚‰é¸ã¶ -->
                <section class="panel">
                    <div class="hd">ã‚¸ãƒ£ãƒ³ãƒ«ã‹ã‚‰é¸ã¶</div>
                    <div class="bd">
                    <div class="chips" aria-label="ã‚¸ãƒ£ãƒ³ãƒ«">
                        <span class="chip">ãƒ“ã‚¸ãƒã‚¹</span>
                        <span class="chip">å°èª¬</span>
                        <span class="chip">æŠ€è¡“ãƒ»IT</span>
                        <span class="chip">èŠ¸è¡“ãƒ»æ–‡åŒ–</span>
                        <span class="chip">æ•°å­¦</span>
                    </div>
                    </div>
                </section>

                <!-- äººæ°—ãƒ¯ãƒ¼ãƒ‰ -->
                <section class="panel">
                    <div class="hd">äººæ°—ã®ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰é¸ã¶</div>
                    <div class="bd">
                    <div class="chips">
                        <span class="chip">çµ±è¨ˆ</span>
                        <span class="chip">AWS</span>
                        <span class="chip">Azure</span>
                        <span class="chip">ãƒ‡ã‚¶ã‚¤ãƒ³</span>
                    </div>
                    </div>
                </section>

                <!-- è‘—è€… -->
                <section class="panel">
                    <div class="hd">è‘—è€…åã‹ã‚‰é¸ã¶</div>
                    <div class="bd">
                    <div class="chips">
                        <span class="chip">AWS</span>
                        <span class="chip">Azure</span>
                        <span class="chip">TK</span>
                    </div>
                    </div>
                </section>

            </aside>

            <!-- ===== Content ===== -->
            <section class="content">

                <!-- ãƒšãƒ¼ã‚¸é·ç§» -->
                <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
                <!-- <div id="login" class="page active"></div> -->

                <!-- ãƒšãƒ¼ã‚¸é·ç§» -->
                <div id="home" class="page active">
                    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                    <section class="panel">
                        <iframe id="rankingFrame" src="ranking.html" width="100%" style="border:none; display:block; padding:0; margin:0;"></iframe>

                        <script> 
                        function resizeIframe() { 
                            const iframe = document.getElementById('rankingFrame'); 
                            if (iframe.contentWindow.document.body) { 
                                const height = iframe.contentWindow.document.body.scrollHeight; 
                                iframe.style.height = height + 30 + 'px'; 
                            } 
                        } 
                        document.getElementById('rankingFrame').addEventListener('load', resizeIframe); </script>
                    </section>
                </div>

                <!-- ãƒšãƒ¼ã‚¸é·ç§» -->
                <div id="kensaku" class="page">
                    <div id="bookSearchResults"></div>
                </div>

                <!-- ãƒšãƒ¼ã‚¸é·ç§» -->
                <div id="recomend" class="page">
                    <!-- ã‚ãªãŸã¸ã®ãŠã™ã™ã‚ -->
                    <section class="panel">
                        <div class="bd">
                        <div class="section-hd">
                            <strong>ã‚ãªãŸã¸ã®ãŠã™ã™ã‚</strong>
                            <span class="muted">æ›´æ–°: ä»Šæ—¥</span>
                        </div>
                        <div class="rail" aria-label="ã‚ãªãŸã¸ã®ãŠã™ã™ã‚ä¸€è¦§">
                            <div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div>
                        </div>
                        </div>
                    </section>
                </div>

                <!-- ãƒšãƒ¼ã‚¸é·ç§» -->
                <div id="popular" class="page">
                    <!-- ã¿ã‚“ãªãŒèª­ã‚“ã§ã„ã‚‹æœ¬ -->
                    <section class="panel">
                        <div class="bd">
                        <div class="section-hd">
                            <strong>ã¿ã‚“ãªãŒèª­ã‚“ã§ã„ã‚‹æœ¬</strong>
                            <span class="muted">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ </span>
                        </div>
                        <div class="rail" aria-label="ãƒˆãƒ¬ãƒ³ãƒ‰æœ¬ä¸€è¦§">
                            <div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div><div class="book"></div>
                        </div>
                        </div>
                    </section>
                </div>

                <!-- ãƒšãƒ¼ã‚¸é·ç§» -->
                <div id="mypage" class="page"></div>
            </section>
            
        </main>
    </div>
    <script src="./search.js"></script>
    <script src="./progressupdate.js"></script>
    <!-- â˜… ãƒ©ãƒ³ã‚­ãƒ³ã‚° iframe ã‹ã‚‰ã®å†Šæ•°ã‚’å—ã‘å–ã‚Šè¡¨ç¤ºã™ã‚‹ï¼ˆè¿½è¨˜ï¼‰ -->
    <script>
        // 1) iframe ã‹ã‚‰ã®é€šçŸ¥ã‚’å—ä¿¡ã—ã¦ã€Œä»Šæœˆã®èª­æ›¸æ•°ã€ã‚’æ›´æ–°
        window.addEventListener('message', (e) => {
            const data = e?.data;
            if (!data || typeof data !== 'object') return;

            // é€²æ—100%ã®ã¿ã§é›†è¨ˆã•ã‚ŒãŸä»Šæœˆã®å†Šæ•°
            if (data.type === 'monthly-count') {
            const el = document.getElementById('monthlyCount');
            if (el) el.textContent = Number(data.count || 0);
            }

            // ï¼ˆä»»æ„ï¼‰æœˆå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘ãŸã„å ´åˆã¯ã“ã“ã§å‡¦ç†
            // if (data.type === 'month-change') { ... }
        });

        // 2) iframe èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ã€åˆå›ã®å†Šæ•°é€ä¿¡ã‚’ä¾é ¼ï¼ˆä¿é™ºï¼‰
        const rankingFrame = document.getElementById('rankingFrame');
        rankingFrame.addEventListener('load', () => {
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å´ï¼ˆranking.jsï¼‰ã§ã“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ monthly-count ã‚’ postMessage ã—ã¦ãã ã•ã„
        rankingFrame.contentWindow?.postMessage({ type: 'request-monthly-count' }, '*');
    });
    </script>

    <script>
        // ==== è¨­å®š ====
        const API_HOME = "http://localhost:4000";
        const MY_USER_ID_HOME = 6;

        // æœˆâ†’é–‹å§‹/çµ‚äº† æ–‡å­—åˆ—
        function monthToRangeHome(ym) {
            let d = ym ? new Date(ym + "-01") : new Date();
            const y = d.getFullYear(), m = d.getMonth();
            const pad = n => String(n).padStart(2, "0");
            const s = new Date(y, m, 1), e = new Date(y, m + 1, 0);
            return {
                start: `${s.getFullYear()}-${pad(s.getMonth()+1)}-${pad(s.getDate())}`,
                end:   `${e.getFullYear()}-${pad(e.getMonth()+1)}-${pad(e.getDate())}`
            };
        }
        function betweenHome(dateStr, s, e){
            if(!s && !e) return true;
            const dt = new Date(dateStr);
            return (!s || dt >= new Date(s)) && (!e || dt <= new Date(e + "T23:59:59.999"));
        }

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚° iframe ã‹ã‚‰æœˆãŒé€ã‚‰ã‚Œã¦æ¥ãŸã‚‰è¿½å¾“
        let currentYMFromRanking = null;
        window.addEventListener("message", (e)=>{
            const data = e?.data;
            if(!data || typeof data !== "object") return;

            if (data.type === "monthly-count" || data.type === "month-change") {
                currentYMFromRanking = data.ym || null;
                renderInProgressArea(currentYMFromRanking);
            }
        });

        // åˆå›ï¼šãƒšãƒ¼ã‚¸èª­è¾¼æ™‚ã«ã‚‚å½“æœˆã§æç”»ï¼ˆiframe ã‹ã‚‰æ¥ãªã„ç’°å¢ƒã§ã‚‚å‡ºã‚‹ã‚ˆã†ã«ï¼‰
        document.addEventListener("DOMContentLoaded", () => {
        renderInProgressArea(null);
        });

        // ===== é€²æ—ï¼ˆ99%ä»¥ä¸‹ï¼‰ãƒªã‚¹ãƒˆæç”» =====
        async function renderInProgressArea(ym){
        const area = document.getElementById("inProgressArea");
        if(!area) return;

        const { start, end } = monthToRangeHome(ym);

        try{
            // books ã¯ç”»åƒãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã®ãŸã‚ã«å–å¾—ï¼ˆç„¡ãã¦ã‚‚å‹•ãã‚ˆã†ã« try/catchï¼‰
            const readings = await fetch(`${API_HOME}/readings`).then(r=>r.json());
            let books = [];
            try { books = await fetch(`${API_HOME}/books`).then(r=>r.json()); } catch(_) {}

                const list = readings
                .filter(r =>
                r.userId === MY_USER_ID_HOME &&
                betweenHome(r.date, start, end) &&
                (r.progress ?? 0) <= 99
                )
                .map(r => ({
                ...r,
                book: books.find(b => b.id === r.bookId) || {}
                }));

                if(list.length === 0){
                    area.innerHTML = `<div class="muted">ï¼ˆé€²è¡Œä¸­ã®æœ¬ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>`;
                    return;
                }

                // èª­ã¿ã‚„ã™ãã‚¿ã‚¤ãƒˆãƒ«é †
                list.sort((a,b)=> (a.book?.title||"").localeCompare(b.book?.title||"","ja"));

                area.innerHTML = list.map(item=>{
                    const img   = item.book?.image || "images/noimage.png";
                    const title = item.book?.title || "ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜ï¼‰";
                    const prog  = item.progress ?? 0;
                    return `
                    <div class="card-row" style="display:flex;align-items:center;gap:12px;">
                    <img src="${img}" alt="" style="width:36px;height:48px;object-fit:cover;border-radius:8px;background:#eee;">
                    <div style="flex:1;min-width:0;">
                    <div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${title}</div>
                    <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
                    <div style="flex:1;height:6px;border-radius:999px;background:#ececec;overflow:hidden;">
                    <div style="height:100%;width:${prog}%;background:#8aa9ff;"></div>
                    </div>
                    <span style="width:42px;text-align:right;" class="muted">${prog}%</span>
                    </div>
                    </div>
                    </div>
                    `;
                }).join("");
        }catch(err){
        console.error(err);
        area.innerHTML = `<div style="color:#c00;">é€²æ—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
        }
        }
    </script>

</body>

</html>
